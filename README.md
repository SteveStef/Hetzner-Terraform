# Hetzner Cloud Terraform Infrastructure

Production-ready infrastructure deployment with Terraform, Docker Compose, automated database backups, and comprehensive health monitoring.

## ✨ Features

- 🚀 **One-click deployment** with Terraform + cloud-init
- 📊 **Dynamic health monitoring** based on enabled services
- 🔄 **Automated database backups & restore** to/from MinIO object storage
- 🔒 **SSL/TLS with Cloudflare** certificates
- 🐳 **Docker Compose** application orchestration
- 📝 **Configuration-driven** via single `config.json` file
- 🎯 **Conditional service deployment** (database, backup optional)

### You only need to edit:
1. **`config.json`** - Single source of truth for all settings
2. **`docker-compose.yml`** - Application containers and environment variables
3. **`certs/`** - Cloudflare SSL certificates (`origin.pem` + `private.key`)

## Quick Start

```bash
# 1. Configure settings
nvim config.json

# 2. Generate config files
./generate-config.sh

# 3. Deploy infrastructure
terraform init 
terraform plan
terraform apply -var-file=build/terraform.tfvars

# Optional testing on the localmachine
docker-compose --env-file build/.env up -d

# CI/CD
Use ./redeploy-app.sh to redeploy your application with fresh code
```

## File Structure

```
├── config.json              # 📝 Single source of truth
├── generate-config.sh       # 🔧 Generates all config files
├── build/
│   ├── terraform.tfvars     # ⚙️  Generated: Infrastructure config
│   ├── .env                 # 🔧 Generated: Docker Compose variables
│   ├── nginx.conf           # 🌐 Generated: NGINX configuration
│   ├── health-check.sh      # 📊 Generated: System health monitoring
│   ├── backup-script.sh     # 💾 Generated: Database backup script (if enabled)
│   ├── setup-backup-timer.sh    # ⏰ Generated: Systemd timer setup (if enabled)
│   └── restore-backup.sh    # 🔄 Generated: Database restore script (if enabled)
├── docker-compose.yml       # 🐳 Container orchestration
├── main.tf                  # 🏗️  Infrastructure definition
├── variables.tf             # 📋 Terraform variables
└── certs/                   # 🔒 SSL certificates from Cloudflare
    ├── origin.pem
    └── private.key
```

### Generated Files (Do Not Edit Manually)
These files are auto-generated by `./generate-config.sh` in the `build/` directory:
- `build/terraform.tfvars` - Infrastructure variables
- `build/.env` - Docker environment variables  
- `build/nginx.conf` - NGINX reverse proxy configuration
- `build/health-check.sh` - Dynamic health monitoring script
- `build/backup-script.sh` - Database backup with MinIO (if backup enabled)
- `build/setup-backup-timer.sh` - Systemd timer configuration (if backup enabled)
- `build/restore-backup.sh` - Database restore script (if backup enabled)

## Key Variables (config.json)

### Critical (Must Be Correct)
- **`domain`**: Must match Cloudflare domain and SSL certificate
- **`docker_port`**: Must match port from dockerfile from github repo
- **`github_repo`**: Must be accessible repository URL

### Important (Affects Access)
- **`my_ip`**: Your IP for SSH access (update when IP changes)
- **`hcloud_token`**: Hetzner Cloud API token

### Server Config
- **`server_type`**: `cpx11` (€4.90/month) or `cpx21` (€9.90/month)
- **`server_location`**: `ash` (US East), `nbg1` (Germany), `hil` (US West)

### Backup Config (Optional)
- **`backup.enabled`**: Enable/disable automated database backups
- **`backup.minio_endpoint`**: MinIO server URL for backup storage
- **`backup.retention_count`**: Number of backups to keep (default: 3)
- **`backup.schedule`**: Backup frequency (see Schedule Options below)

### Database Config (Optional)
- **`database.enabled`**: Enable/disable database container
- **`database.name`**: Database name to backup
- **`database.password`**: Database root password
- **`database.container_name`**: Docker container name (default: "mysql")

## Backup Schedule Options

Configure automated backup frequency with the `backup.schedule` setting:

| Schedule Option | Systemd OnCalendar | Description |
|-----------------|-------------------|-------------|
| `daily_2am` | `*-*-* 02:00:00` | Daily at 2:00 AM (default) |
| `daily_midnight` | `*-*-* 00:00:00` | Daily at midnight |
| `daily_6am` | `*-*-* 06:00:00` | Daily at 6:00 AM |
| `daily_noon` | `*-*-* 12:00:00` | Daily at noon |
| `twice_daily` | `*-*-* 02:00:00,14:00:00` | Twice daily (2 AM and 2 PM) |
| `weekly_sunday` | `Sun *-*-* 02:00:00` | Weekly on Sunday at 2 AM |
| `weekly_monday` | `Mon *-*-* 02:00:00` | Weekly on Monday at 2 AM |
| `hourly` | `*-*-* *:00:00` | Every hour on the hour |

### Schedule Examples

```json
{
  "backup": {
    "enabled": true,
    "schedule": "daily_2am",
    "retention_count": 7
  }
}
```

**For production systems:**
- `daily_2am` - Low-traffic time, good default
- `daily_midnight` - Start of day in UTC
- `weekly_sunday` - Reduced frequency for large databases

**For development/testing:**
- `hourly` - Frequent backups for active development
- `twice_daily` - Balance between safety and storage

**Notes:**
- All times are in server timezone (UTC in cloud deployments)
- Unknown schedule values default to `daily_2am`
- Changes require running `./generate-config.sh` and redeployment

## 🔧 System Monitoring

The system includes an intelligent health check script that dynamically monitors enabled services:

### Health Check Features
- ✅ **Conditional monitoring** - Only checks enabled services
- ✅ **Cloud-init validation** - Ensures deployment completed
- ✅ **Container health** - Verifies app and database containers
- ✅ **Web connectivity** - Tests nginx and application response
- ✅ **Database connectivity** - Validates database connections (if enabled)
- ✅ **Backup system** - Monitors systemd timers and MinIO connectivity (if enabled)
- ✅ **Resource monitoring** - Disk space and memory usage warnings

### Running Health Checks
```bash
# SSH into your server
ssh ubuntu@your-server-ip

# Run comprehensive health check
./health-check.sh
```

**Example Output:**
```
🔍 System Health Check
=====================
[CLOUD-INIT] Cloud-init completion... ✅ OK
[DOCKER] Docker service... ✅ OK
[CONTAINER] App container running... ✅ OK
[CONTAINER] Database container running... ✅ OK
[NGINX] Nginx service... ✅ OK
[NGINX] Nginx configuration... ✅ OK
[WEB] Web app responding... ✅ OK
[DATABASE] Database connectivity... ✅ OK
[BACKUP] Backup timer active... ✅ OK
[MINIO] MinIO connectivity... ✅ OK
[SYSTEM] Disk space (15% used)... ✅ OK
[SYSTEM] Memory usage (23% used)... ✅ OK

Summary:
🎉 All systems operational! (12/12 checks passed)
```

## 🚨 Common Issues

- **Can't SSH**: Check `my_ip` matches your current IP
- **App won't start**: Verify `docker_port` matches application port
- **Domain not working**: Ensure `domain` matches Cloudflare exactly
- **Database connection**: Check logs with `docker-compose logs -f`
- **Backup failing**: Check backup logs with `sudo journalctl -u backup.service -f`
- **MinIO connection**: Verify MinIO credentials and endpoint in config.json
- **Health check failures**: Run `./health-check.sh` for detailed diagnostics

## Useful Commands

### Server Management
```bash
# SSH into server
ssh ubuntu@your-server-ip

# Restart server
sudo reboot

# Check server status
systemctl status nginx
systemctl status docker
```

### Docker Commands
```bash
# View running containers
docker ps

# View all containers
docker ps -a

# View container logs
docker logs web-app
docker logs mysql-db

# Follow logs live
docker logs -f web-app

# Restart containers
docker-compose --env-file build/.env down
docker-compose --env-file build/.env up -d

# Rebuild and restart
docker-compose --env-file build/.env up -d --build
```

### Database Commands
```bash
# Connect to MySQL container
docker exec -it mysql-db mysql -u root -p

# View database files
sudo ls -la /var/lib/docker/volumes/ubuntu_mysql_data/_data/

# Backup database
docker exec mysql-db mysqldump -u root -p default > backup.sql

# Check database connection from app
docker exec -it web-app ping mysql
```

### Cloud-Init Debugging
```bash
# Check cloud-init status
cloud-init status

# View cloud-init logs
cat /var/log/cloud-init-output.log
cat /var/log/cloud-init.log

# Search for errors
grep -i error /var/log/cloud-init-output.log
```

### NGINX Commands
```bash
# Test NGINX configuration
nginx -t

# Restart NGINX
systemctl restart nginx

# View NGINX logs
tail -f /var/log/nginx/error.log
tail -f /var/log/nginx/access.log
```

### Backup System Commands
```bash
# Check backup timer status
sudo systemctl status backup.timer

# Check backup service status  
sudo systemctl status backup.service

# View backup logs (live)
sudo journalctl -u backup.service -f

# View backup logs (last 24 hours)
sudo journalctl -u backup.service --since "24 hours ago"

# View backup script log file
tail -f /var/log/database-backup.log

# List all systemd timers
systemctl list-timers

# Manually trigger backup (for testing)
sudo systemctl start backup.service

# Stop backup timer
sudo systemctl stop backup.timer

# Disable backup timer
sudo systemctl disable backup.timer

# Re-enable backup timer
sudo systemctl enable backup.timer
sudo systemctl start backup.timer
```

### MinIO Client Commands
```bash
# Install MinIO client (if not auto-installed)
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/

# Configure MinIO connection
mc alias set backup-server https://your-minio-endpoint ACCESS_KEY SECRET_KEY --insecure

# List all buckets
mc ls backup-server

# List backup files
mc ls backup-server/database-backups/

# Check backup file sizes and dates
mc ls -r backup-server/database-backups/

# Download a specific backup
mc cp backup-server/database-backups/db_backup_20240101_020000.sql.gz /tmp/

# Monitor backup uploads in real-time
watch -n 5 'mc ls backup-server/database-backups/'
```

### Manual Database Restore Commands
```bash
# Manually restore from latest backup
./restore-backup.sh

# View restore logs
tail -f /home/ubuntu/restore-backup.log

# List available backups for restore
mc ls backup-server/YOUR-BUCKET-NAME/

# Check pre-restore backup files
ls -la /tmp/pre_restore_backup_*.sql

# Restore specific backup file
mc cp backup-server/YOUR-BUCKET-NAME/db_backup_YYYYMMDD_HHMMSS.sql.gz /tmp/
gunzip -c /tmp/db_backup_YYYYMMDD_HHMMSS.sql.gz | docker exec -i mysql mysql -u root -pPASSWORD default

# Rollback using pre-restore backup
docker exec -i mysql mysql -u root -pPASSWORD default < /tmp/pre_restore_backup_YYYYMMDD_HHMMSS.sql
```

### System Health Monitoring
```bash
# Run comprehensive health check
./health-check.sh

# Check cloud-init completion
sudo cloud-init status

# Monitor all services at once
systemctl status docker nginx backup.timer
```

### Backup Troubleshooting
```bash
# Check if backup script exists and is executable
ls -la /home/ubuntu/backup-script.sh

# Test backup script manually
sudo -u ubuntu /home/ubuntu/backup-script.sh

# Check MinIO client is installed
mc --version

# Test MinIO connection
mc ls backup-server 2>&1

# Check if database container is running
docker ps | grep mysql

# Test database connection from backup script perspective
docker exec mysql-db mysqladmin -uroot -pYOUR_PASSWORD ping

# Check backup script variables
head -20 /home/ubuntu/backup-script.sh

# View systemd service definition
cat /etc/systemd/system/backup.service

# View systemd timer definition  
cat /etc/systemd/system/backup.timer

# Check systemd service logs for errors
sudo systemctl status backup.service -l
```

## Backup & Restore System Overview

The system automatically:
1. **Creates database backups** daily at 2:00 AM
2. **Compresses backups** (.sql.gz format) to save space
3. **Uploads to MinIO** object storage server
4. **Maintains retention** (keeps only specified number of backups)
5. **Restores latest backup** during infrastructure deployment
6. **Logs all operations** for monitoring and troubleshooting

### Automatic Restore Process

When `backup_enabled: true` in config.json, the deployment automatically:
1. **Deploys infrastructure** and starts containers
2. **Sets up backup system** with scheduled backups
3. **Waits for services** to stabilize (30 seconds)
4. **Automatically restores** the latest backup from MinIO
5. **Restarts containers** to ensure clean application state

This ensures new deployments start with the most recent backed-up data.

### Key Backup & Restore Files:
- `/var/log/database-backup.log` - Backup script log file
- `/home/ubuntu/restore-backup.log` - Restore script log file
- `/etc/systemd/system/backup.service` - Systemd service definition
- `/etc/systemd/system/backup.timer` - Systemd timer (schedule)
- `/home/ubuntu/backup-script.sh` - Main backup script
- `/home/ubuntu/restore-backup.sh` - Database restore script
- `/home/ubuntu/health-check.sh` - System health monitoring script

### Backup Monitoring:
```bash
# Quick backup status check
sudo systemctl status backup.timer backup.service

# View recent backup activity
tail -20 /var/log/database-backup.log

# Check next scheduled backup
systemctl list-timers backup.timer
```

## Security

- Never commit `build/terraform.tfvars`, `build/.env`, or `build/backup-script.sh` to git
- Update `my_ip` when your IP changes
- Keep SSL certificates current in Cloudflare
- Store MinIO credentials securely in config.json
- Regularly test backup restoration process

## Server Instance Types

| Type | Price/Month | vCPU | RAM | SSD | Traffic | Best For |
|------|-------------|------|-----|-----|---------|----------|
| `cpx11` | €4.99 (~$5.40) | 2 | 2 GB | 40 GB | 1 TB | Small apps, testing |
| `cpx21` | €9.49 (~$10.30) | 3 | 4 GB | 80 GB | 2 TB | Production apps |
| `cpx31` | €16.49 (~$17.90) | 4 | 8 GB | 160 GB | 3 TB | High traffic apps |
| `cpx41` | €30.49 (~$33.10) | 8 | 16 GB | 240 GB | 4 TB | Enterprise apps |
| `cpx51` | €60.49 (~$65.70) | 16 | 32 GB | 360 GB | 5 TB | Large scale apps |

## US Server Locations

| Location Code | City | Region | Best For |
|---------------|------|--------|----------|
| `ash` | Ashburn, VA | US East | East Coast customers |
| `hil` | Hillsboro, OR | US West | West Coast customers |

## Image Types

| Image | Description | Use Case |
|-------|-------------|----------|
| `ubuntu-22.04` | Ubuntu 22.04 LTS | Recommended (default) |
| `ubuntu-20.04` | Ubuntu 20.04 LTS | Legacy support |
| `debian-11` | Debian 11 | Alternative to Ubuntu |
| `centos-stream-9` | CentOS Stream 9 | Enterprise environments |
| `fedora-39` | Fedora 39 | Latest features |

### Helpful commands
```
ssh-keygen -R IP

```
### docker-compose for NEXT.JS project:
```
services:
  app:
    build: 
      context: ./${APP_NAME}
      args:
        - var=hello
    container_name: ${APP_NAME}
    ports:
      - "${APP_PORT}:${DOCKER_PORT}"
    restart: unless-stopped
```

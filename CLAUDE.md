# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a Terraform-based infrastructure deployment system for Hetzner Cloud that provisions web servers with automated Docker application deployment and database backup to MinIO storage. The system uses a configuration-driven approach where a single `config.json` file drives the generation of all required configuration files.

## Architecture

The system consists of three main layers:

1. **Infrastructure Layer**: Terraform provisions Hetzner Cloud resources (server, firewall, SSH keys)
2. **Application Layer**: Docker Compose manages containerized applications with automatic deployment
3. **Backup Layer**: Automated database backups to MinIO object storage via systemd timers

### Key Components

- **config.json**: Single source of truth for all configuration
- **generate-config.sh**: Generates build/terraform.tfvars, build/nginx.conf, build/.env, and backup scripts from config.json
- **main.tf**: Terraform infrastructure definition with cloud-init user data
- **docker-compose.yml**: Container orchestration template
- **Backup System**: Automated MySQL backups to MinIO with retention management

## Common Development Commands

### Configuration Management
```bash
# Generate all config files from config.json
./generate-config.sh

# Validate generated terraform.tfvars
terraform plan -var-file=build/terraform.tfvars
```

### Infrastructure Deployment
```bash
# Initialize terraform
terraform init

# Plan infrastructure changes
terraform plan -var-file=build/terraform.tfvars

# Deploy infrastructure
terraform apply -var-file=build/terraform.tfvars

# Destroy infrastructure
terraform destroy -var-file=build/terraform.tfvars
```

### Configuration Structure

The `config.json` file has four main sections:
- `infrastructure`: Hetzner Cloud and server settings
- `application`: App deployment settings (ports, domain, repository)
- `backup`: MinIO backup configuration (optional)
- `database`: MySQL database settings (optional)

### Generated Files (Do Not Edit Manually)

These files are auto-generated by `generate-config.sh` and placed in the `build/` directory:
- `build/terraform.tfvars`: Infrastructure variables for Terraform
- `build/nginx.conf`: NGINX reverse proxy configuration
- `build/.env`: Docker Compose environment variables
- `build/backup-script.sh`: Database backup script (if backup enabled)
- `build/setup-backup-timer.sh`: Systemd timer setup script (if backup enabled)

### Cloud-Init Process

The Terraform configuration uses cloud-init to:
1. Install required packages (nginx, docker, git)
2. Deploy SSL certificates from Cloudflare
3. Configure NGINX with domain and SSL
4. Clone the specified GitHub repository
5. Start Docker containers via docker-compose
6. Set up automated backup system (if enabled)

### SSL Certificate Requirements

SSL certificates must be obtained from Cloudflare and placed in `certs/`:
- `certs/origin.pem`: Cloudflare Origin Certificate
- `certs/private.key`: Private key

Steps to obtain certificates are documented in `cloudflare.md`.

### Backup System

When enabled, the backup system:
- Creates automated MySQL database backups daily at 2:00 AM
- Compresses backups (.sql.gz format)
- Uploads to MinIO object storage
- Maintains configurable retention count (default: 3 backups)
- Logs all operations to `/var/log/database-backup.log`

## Critical Variables

These variables must be correctly configured:
- `infrastructure.domain`: Must match Cloudflare domain exactly
- `infrastructure.docker_port`: Must match application's internal port
- `infrastructure.my_ip`: Your public IP for SSH access
- `infrastructure.hcloud_token`: Hetzner Cloud API token

## Security Considerations

- Never commit sensitive files: `build/terraform.tfvars`, `build/.env`, `build/backup-script.sh`
- SSL certificates are deployed via cloud-init (base64 encoded)
- SSH access restricted to specified IP address only
- Database credentials passed through environment variables

## Testing and Validation

After deployment, verify:
1. SSH access: `ssh ubuntu@<server-ip>`
2. Web application: `https://<domain>`
3. Docker containers: `docker ps`
4. NGINX configuration: `nginx -t`
5. Backup system (if enabled): `sudo systemctl status backup.timer`

## Common Issues and Debugging

- **SSH access denied**: Check `my_ip` matches current public IP
- **Domain not working**: Verify domain matches Cloudflare exactly
- **App startup issues**: Check `docker logs <container-name>`
- **Backup failures**: Check logs with `sudo journalctl -u backup.service -f`
- **MinIO connection issues**: Verify credentials and endpoint in config.json
